<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Track and manage regular check-ins with your mentees">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Mentee Tracker">
    <title>Mentee Connection Tracker</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --danger: #dc2626;
            --warning: #f59e0b;
            --success: #10b981;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.6;
            padding-bottom: 2rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Header */
        header {
            background: white;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        h1 {
            color: var(--primary);
            font-size: 1.75rem;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: var(--gray-600);
            font-size: 0.95rem;
        }

        .connection-status {
            margin-top: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .connection-status.connected {
            background: #d1fae5;
            color: #059669;
            border: 1px solid #10b981;
        }

        .connection-status.error {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #ef4444;
        }

        .connection-status.loading {
            background: #fef3c7;
            color: #d97706;
            border: 1px solid #f59e0b;
        }

        /* New Header Layout */
        .main-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            position: relative;
        }

        .header-left, .header-center, .header-right {
            display: flex;
            align-items: center;
        }

        .stats-compact {
            display: flex;
            gap: 1rem;
            margin-left: 1rem;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .stat-item span {
            font-weight: 600;
            color: #374151;
        }

        .header-center {
            flex: 1;
            max-width: 500px;
            margin: 0 2rem;
        }

        .menu-button {
            display: flex;
            flex-direction: column;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }

        .menu-button:hover {
            background-color: #f3f4f6;
        }

        .menu-button span {
            width: 20px;
            height: 2px;
            background-color: #374151;
            margin: 2px 0;
            transition: 0.3s;
        }

        .search-box {
            width: 100%;
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        .add-button {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 1.2rem;
            font-weight: bold;
        }

        /* Dropdown Menu */
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 1rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
            min-width: 200px;
        }

        .dropdown-menu.show {
            display: block;
        }

        .menu-item {
            display: block;
            width: 100%;
            padding: 0.75rem 1rem;
            text-align: left;
            border: none;
            background: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .menu-item:hover {
            background-color: #f3f4f6;
        }

        .mentee-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .mentee-list-item:hover {
            background-color: #f9fafb;
        }

        .mentee-list-item:last-child {
            border-bottom: none;
        }

        .mentee-info {
            flex: 1;
        }

        .mentee-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 0.25rem;
        }

        .mentee-details {
            display: flex;
            gap: 1rem;
            font-size: 0.9rem;
            color: #6b7280;
        }

        .school {
            font-weight: 500;
        }

        .year {
            color: #9ca3af;
        }

        .mentee-arrow {
            color: #9ca3af;
            font-size: 1.2rem;
        }

        .contact-view {
            max-width: 600px;
            margin: 0 auto;
            padding: 1rem;
        }

        .contact-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .header-left-nav, .header-right-nav {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-back, .btn-nav {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
            color: #374151;
            font-size: 0.9rem;
        }

        .btn-back:hover, .btn-nav:hover {
            background: #e5e7eb;
        }

        .btn-nav {
            background: #3b82f6;
            color: white;
            border: 1px solid #2563eb;
        }

        .btn-nav:hover {
            background: #2563eb;
        }

        .btn-nav:disabled {
            background: #9ca3af;
            color: #6b7280;
            border: 1px solid #d1d5db;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-nav:disabled:hover {
            background: #9ca3af;
        }

        .contact-header h2 {
            margin: 0;
            color: #111827;
        }

        .contact-info {
            margin-bottom: 2rem;
        }

        .contact-item {
            display: flex;
            align-items: flex-start;
            padding: 1rem 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .contact-item:last-child {
            border-bottom: none;
        }

        .contact-label {
            min-width: 120px;
            font-weight: 600;
            color: #374151;
            margin-right: 1rem;
        }

        .contact-value {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .contact-value a {
            color: #2563eb;
            text-decoration: none;
        }

        .contact-value a:hover {
            text-decoration: underline;
        }

        .btn-call, .btn-text, .btn-email {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 0.375rem;
            padding: 0.25rem 0.75rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-call:hover, .btn-text:hover, .btn-email:hover {
            background: #2563eb;
        }

        .btn-text-small {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-left: 0.5rem;
        }

        .btn-text-small:hover {
            background: #059669;
        }

        .btn-insert-text {
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-left: 0.5rem;
        }

        .btn-insert-text:hover {
            background: #7c3aed;
        }

        .contact-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .contact-actions button {
            flex: 1;
            min-width: 150px;
        }

        .contact-title {
            flex: 1;
            text-align: center;
        }

        .contact-status {
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .status-red {
            color: #dc2626;
        }

        .status-green {
            color: #16a34a;
        }

        .status-yellow {
            color: #ca8a04;
        }

        .btn-edit {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
            color: #374151;
            font-size: 0.9rem;
        }

        .btn-edit:hover {
            background: #e5e7eb;
        }

        .contact-photo-section {
            text-align: center;
            margin: 2rem 0;
        }

        .contact-photo {
            display: inline-block;
            position: relative;
        }

        .profile-photo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #e5e7eb;
        }

        .photo-placeholder {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: #f3f4f6;
            border: 3px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #9ca3af;
        }

        .btn-photo {
            position: absolute;
            bottom: 0;
            right: 0;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .btn-photo:hover {
            background: #2563eb;
        }

        .contact-log-section {
            margin: 2rem 0;
            padding: 1.5rem;
            background: #f9fafb;
            border-radius: 0.5rem;
        }

        .contact-log-section h3 {
            margin: 0 0 1rem 0;
            color: #111827;
        }

        .log-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .contact-item .log-buttons {
            margin: 0;
        }

        .btn-log {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        .btn-log:hover {
            background: #2563eb;
        }

        .btn-log.txt {
            background: #10b981;
        }

        .btn-log.txt:hover {
            background: #059669;
        }

        .btn-log.call {
            background: #f59e0b;
        }

        .btn-log.call:hover {
            background: #d97706;
        }

        .btn-log.email {
            background: #8b5cf6;
        }

        .btn-log.email:hover {
            background: #7c3aed;
        }

        .btn-log.ftf {
            background: #ef4444;
        }

        .btn-log.ftf:hover {
            background: #dc2626;
        }

        .interaction-history {
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: white;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            border: 1px solid #e5e7eb;
        }

        .log-icon {
            font-size: 1.2rem;
        }

        .log-date {
            font-size: 0.9rem;
            color: #6b7280;
            min-width: 120px;
        }

        .log-notes {
            flex: 1;
            color: #374151;
        }

        .no-interactions {
            text-align: center;
            color: #9ca3af;
            font-style: italic;
            padding: 2rem;
        }

        .contact-notes {
            margin: 2rem 0;
            padding: 1.5rem;
            background: #f9fafb;
            border-radius: 0.5rem;
        }

        .contact-notes h3 {
            margin: 0 0 1rem 0;
            color: #111827;
        }

        .notes-content {
            background: white;
            padding: 1rem;
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb;
            white-space: pre-wrap;
            color: #374151;
        }

        .menu-item:first-child {
            border-radius: 0.5rem 0.5rem 0 0;
        }

        .menu-item:last-child {
            border-radius: 0 0 0.5rem 0.5rem;
        }

        /* Stats Bar */
        .stats-bar {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            flex: 1;
            min-width: 150px;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            color: var(--gray-600);
            font-size: 0.875rem;
        }

        /* Search and Controls */
        .controls {
            background: white;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
        }

        .search-box {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        input[type="text"], input[type="search"], input[type="email"], input[type="tel"], select {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 1rem;
        }

        select {
            background-color: white;
            cursor: pointer;
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .button-row {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        button {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-300);
        }

        .error-message {
            color: #dc2626;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 6px;
        }

        .btn-small {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }

        .btn-text {
            background: var(--success);
            color: white;
        }

        .btn-call {
            background: var(--primary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        /* Mentee List */
        .mentee-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .mentee-card {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--gray-300);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .mentee-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .mentee-card.priority-red {
            border-left-color: var(--danger);
        }

        .mentee-card.priority-yellow {
            border-left-color: var(--warning);
        }

        .mentee-card.priority-green {
            border-left-color: var(--success);
        }

        .mentee-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }

        .mentee-info h3 {
            font-size: 1.25rem;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }

        .mentee-specialty {
            color: var(--gray-600);
            font-size: 0.875rem;
        }

        .mentee-detail {
            color: var(--gray-500);
            font-size: 0.813rem;
            margin-top: 0.125rem;
        }

        .priority-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .priority-badge.red {
            background: #fee2e2;
            color: var(--danger);
        }

        .priority-badge.yellow {
            background: #fef3c7;
            color: #d97706;
        }

        .priority-badge.green {
            background: #d1fae5;
            color: #059669;
        }

        .mentee-actions {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .mentee-notes {
            background: var(--gray-50);
            padding: 0.75rem;
            border-radius: 8px;
            margin-top: 0.75rem;
            font-size: 0.875rem;
            color: var(--gray-700);
        }

        .mentee-notes.empty {
            color: var(--gray-400);
            font-style: italic;
        }

        .mentee-history {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--gray-200);
        }

        .history-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .history-item {
            font-size: 0.813rem;
            color: var(--gray-600);
            padding: 0.25rem 0;
        }

        .history-icon {
            display: inline-block;
            width: 1.5rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            color: var(--gray-900);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-500);
            cursor: pointer;
            padding: 0;
            width: 2rem;
            height: 2rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--gray-700);
        }

        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .modal-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--gray-500);
        }

        .empty-state p {
            font-size: 1.125rem;
            margin-bottom: 1rem;
        }

        /* Hidden file input */
        #importFile {
            display: none;
        }

        /* Security Status */
        .security-status {
            padding: 0.75rem;
            border-radius: 8px;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .security-status.encrypted {
            background: #d1fae5;
            color: #059669;
            border: 1px solid #10b981;
        }

        .security-status.unencrypted {
            background: #fef3c7;
            color: #d97706;
            border: 1px solid #f59e0b;
        }

        .form-group small {
            color: var(--gray-500);
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: block;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: var(--gray-900);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        /* Responsive */
        @media (max-width: 640px) {
            h1 {
                font-size: 1.5rem;
            }

            .stats-bar {
                flex-direction: column;
            }

            .stat-card {
                min-width: 100%;
            }

            .button-row {
                flex-direction: column;
            }

            button {
                width: 100%;
            }

            .mentee-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header with Menu and Search -->
        <header class="main-header">
            <div class="header-left">
                <div class="menu-button" onclick="app.toggleMenu()">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            <div class="header-center">
            <div class="search-box">
                    <input type="search" id="searchInput" placeholder="Search mentees...">
            </div>
            </div>
            <div class="header-right">
                <button class="btn-primary add-button" onclick="app.showAddMenteeModal()">+</button>
            </div>
        </header>

        <!-- Dropdown Menu -->
        <div id="dropdownMenu" class="dropdown-menu">
            <button class="menu-item" onclick="app.showStats()">üìä Statistics</button>
            <button class="menu-item" onclick="app.showTemplateEditor()">‚úèÔ∏è Edit Message Template</button>
            <button class="menu-item" onclick="app.showBulkImportModal()">üì• Bulk Import</button>
            <button class="menu-item" onclick="app.exportData()">üì§ Export Data</button>
            <button class="menu-item" onclick="document.getElementById('importFile').click()">üìÅ Import Data</button>
            <input type="file" id="importFile" accept=".json" onchange="app.importData(event)" style="display: none;">
        </div>

        <!-- Mentee List -->
        <div id="menteeList" class="mentee-list"></div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Edit Notes Modal -->
    <div id="notesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Notes</h2>
                <button class="close-btn" onclick="app.closeModal('notesModal')">&times;</button>
            </div>
            <div class="form-group">
                <label for="notesText">Notes for <span id="notesModalName"></span></label>
                <textarea id="notesText" placeholder="Add notes about goals, interests, updates..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="app.closeModal('notesModal')">Cancel</button>
                <button class="btn-primary" onclick="app.saveNotes()">Save Notes</button>
            </div>
        </div>
    </div>

    <!-- Add Mentee Modal -->
    <div id="addMenteeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Mentee</h2>
                <button class="close-btn" onclick="app.closeModal('addMenteeModal')">&times;</button>
            </div>
            <div class="form-group">
                <label for="menteeName">Name *</label>
                <input type="text" id="menteeName" placeholder="Enter mentee's name" required>
            </div>
            <div class="form-group">
                <label for="menteeMobile">Mobile *</label>
                <input type="tel" id="menteeMobile" placeholder="e.g. (555) 123-4567" required>
            </div>
            <div class="form-group">
                <label for="menteeEmail">Email *</label>
                <input type="email" id="menteeEmail" placeholder="e.g. mentee@example.com" required>
            </div>
            <div class="form-group">
                <label for="menteeFu">Follow-up Days (FU) *</label>
                <input type="number" id="menteeFu" placeholder="e.g. 30" min="1" required>
                <small>Maximum days between follow-ups before alert</small>
            </div>
            <div class="form-group">
                <label for="menteeQs">Quad Squad (QS)</label>
                <input type="text" id="menteeQs" placeholder="e.g. A, B, C, etc.">
            </div>
            <div class="form-group">
                <label for="menteePoc">Point of Contact (POC)</label>
                <select id="menteePoc">
                    <option value="">No</option>
                    <option value="Yes">Yes</option>
                </select>
            </div>
            <div class="form-group">
                <label for="menteeMf">Male/Female (MF)</label>
                <select id="menteeMf">
                    <option value="">Select</option>
                    <option value="M">Male</option>
                    <option value="F">Female</option>
                </select>
            </div>
            <div class="form-group">
                <label for="menteeLot">Leg of Training (LOT)</label>
                <select id="menteeLot">
                    <option value="">Select</option>
                    <option value="HS">High School</option>
                    <option value="UG">Undergrad</option>
                    <option value="G">Grad School</option>
                    <option value="RF">Resident/Fellow</option>
                    <option value="W">Working/Graduate</option>
                </select>
            </div>
            <div class="form-group">
                <label for="menteeTyp">Type of School (TYP)</label>
                <input type="text" id="menteeTyp" placeholder="e.g. M (Medical), DEN (Dental), etc.">
            </div>
            <div class="form-group">
                <label for="menteeLoc">Location (LOC)</label>
                <input type="text" id="menteeLoc" placeholder="College/Grad School Name, Hospital Name">
            </div>
            <div class="form-group">
                <label for="menteeYr">Year (YR)</label>
                <input type="text" id="menteeYr" placeholder="Year in program or practice">
            </div>
            <div class="form-group">
                <label for="menteeNotes">Notes</label>
                <textarea id="menteeNotes" placeholder="Additional notes" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="menteeAddress">Address</label>
                <textarea id="menteeAddress" placeholder="Home address" rows="2"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="app.closeModal('addMenteeModal')">Cancel</button>
                <button class="btn-primary" onclick="app.addMentee()">Add Mentee</button>
            </div>
        </div>
    </div>

    <!-- Bulk Import Modal -->
    <div id="bulkImportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì• Bulk Import from Google Sheets</h2>
                <button class="close-btn" onclick="app.closeModal('bulkImportModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Import Options</label>
                <div style="margin: 1rem 0;">
                    <label style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                        <input type="radio" name="importType" value="fromExistingSheet" checked style="margin-right: 0.5rem;">
                        Import from your clean Quad Squad spreadsheet (112 mentees)
                    </label>
                    <label style="display: flex; align-items: center;">
                        <input type="radio" name="importType" value="fromNewSheet" style="margin-right: 0.5rem;">
                        Import from different Google Sheet
                    </label>
                </div>
            </div>
            <div id="newSheetConfig" style="display: none;">
                <div class="form-group">
                    <label for="importSheetId">Google Sheet ID</label>
                    <input type="text" id="importSheetId" placeholder="Enter Google Sheet ID">
                    <small>Get this from the sheet URL: docs.google.com/spreadsheets/d/SHEET_ID/edit</small>
                </div>
            </div>
            <div class="form-group">
                <label>Import Settings</label>
                <div style="margin: 1rem 0;">
                    <label style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                        <input type="checkbox" id="skipDuplicates" checked style="margin-right: 0.5rem;">
                        Skip duplicates (based on name)
                    </label>
                    <label style="display: flex; align-items: center;">
                        <input type="checkbox" id="clearExisting" style="margin-right: 0.5rem;">
                        Clear existing data before import
                    </label>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="app.closeModal('bulkImportModal')">Cancel</button>
                <button class="btn-primary" onclick="app.startBulkImport()">Start Import</button>
            </div>
        </div>
    </div>

    <!-- Template Editor Modal -->
    <div id="templateEditorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Edit Message Template</h2>
                <button class="close-btn" onclick="app.closeModal('templateEditorModal')">&times;</button>
            </div>
            <div class="form-group">
                <label for="templateSubject">Subject Line:</label>
                <input type="text" id="templateSubject" placeholder="Enter email subject (leave blank for no template)">
            </div>
            <div class="form-group">
                <label for="templateBody">Message Body:</label>
                <textarea id="templateBody" rows="15" placeholder="Enter message body. Use [FirstName] as a placeholder for the mentee's first name. Leave blank to disable template."></textarea>
                <small>Use [FirstName] to insert the mentee's first name automatically</small>
            </div>
            <div class="form-group">
                <button class="btn-secondary" onclick="app.clearTemplate()" style="margin-right: 0.5rem;">Clear Template</button>
                <small style="color: #6b7280;">Clearing the template will disable automatic text insertion</small>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="app.closeModal('templateEditorModal')">Cancel</button>
                <button class="btn-primary" onclick="app.saveTemplate()">Save Template</button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // SIMPLE SETUP - JUST 2 STEPS!
        // ========================================
        
        // STEP 1: Create a Google Sheet
        // 1. Go to https://sheets.google.com
        // 2. Create a new blank spreadsheet
        // 3. Make it public: Share ‚Üí Anyone with link can edit
        // 4. Copy the Sheet ID from URL: https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID/edit
        const GOOGLE_SHEET_ID = '1wuo6HFBtSFWDH95HZ1uCtLVZ777uVVtcp0GI95Qcyvw';
        
        // Template content - loaded from localStorage or default
        function getDefaultTemplate() {
            return `Subject: Join us for Special Outpost Dinner & Talk this evening at the Hey's!

Body:
Hi [FirstName]!
Hope your week has been going well!
Lori and I hope you can carve time out of your day today to join us for a very special Outpost dinner at our home.
We're going to share a great meal together, a short time of worship, and then hear from a great speaker, Bob Mason, who is coming all the way from southern California to join us!
Bob has been training young future physicians how to fully integrate their faith with their work life in medicine, including how to take a good spiritual history.
We'll meet from 5:55p-8:00p at our home at 6704 Creek Wood Drive, Chapel Hill.

If you can't join us in person due to rotations, or other travel, we'll also have Bob's talk on Zoom starting at 7:00pm
https://us02web.zoom.us/j/9192150170?pwd=RRNoON3J5M1gh21PCAJ8lTnu75a90J.1&omn=88535613636
Meeting ID: 919 215 0170
Passcode: Outpost

Hope to see you in person though!  Feel free to bring a friend.
If you can email me back so we can get a good head count for dinner that would be helpful.
Hope to see you soon!
Dr. Hey
m 919-215-0170`;
        }
        
        // Load template from localStorage or use default
        function loadTemplate() {
            const saved = localStorage.getItem('messageTemplate');
            return saved || getDefaultTemplate();
        }
        
        // Save template to localStorage
        function saveTemplateToStorage(template) {
            if (template && template.trim()) {
                localStorage.setItem('messageTemplate', template);
            } else {
                localStorage.removeItem('messageTemplate');
            }
        }
        
        // STEP 2: Get Google OAuth2 Client ID
        // 1. Go to https://console.cloud.google.com/
        // 2. Create project or select existing
        // 3. Enable "Google Sheets API"
        // 4. Go to Credentials ‚Üí Create Credentials ‚Üí OAuth 2.0 Client ID
        // 5. Application type: Web Application
        // 6. Authorized origins: https://lloydhey.github.io
        // 7. Copy the Client ID here
        const GOOGLE_CLIENT_ID = '48894897363-42h3nabi6v0b8kcistmisb87kup8tlq3.apps.googleusercontent.com';
        
        // ========================================
        // THAT'S IT! No OAuth, no login required!
        // ========================================
        
        // Simple encryption utilities (keeping for potential future use)
        class SimpleCrypto {
            static async encrypt(text, password) {
                const encoder = new TextEncoder();
                const data = encoder.encode(text);
                const key = await crypto.subtle.importKey(
                    'raw',
                    encoder.encode(password),
                    { name: 'PBKDF2' },
                    false,
                    ['deriveBits', 'deriveKey']
                );
                const salt = crypto.getRandomValues(new Uint8Array(16));
                const derivedKey = await crypto.subtle.deriveKey(
                    { name: 'PBKDF2', salt: salt, iterations: 100000, hash: 'SHA-256' },
                    key,
                    { name: 'AES-GCM', length: 256 },
                    false,
                    ['encrypt']
                );
                const iv = crypto.getRandomValues(new Uint8Array(12));
                const encrypted = await crypto.subtle.encrypt(
                    { name: 'AES-GCM', iv: iv },
                    derivedKey,
                    data
                );
                return {
                    encrypted: Array.from(new Uint8Array(encrypted)),
                    salt: Array.from(salt),
                    iv: Array.from(iv)
                };
            }

            static async decrypt(encryptedData, password) {
                const encoder = new TextEncoder();
                const decoder = new TextDecoder();
                const key = await crypto.subtle.importKey(
                    'raw',
                    encoder.encode(password),
                    { name: 'PBKDF2' },
                    false,
                    ['deriveBits', 'deriveKey']
                );
                const derivedKey = await crypto.subtle.deriveKey(
                    { name: 'PBKDF2', salt: new Uint8Array(encryptedData.salt), iterations: 100000, hash: 'SHA-256' },
                    key,
                    { name: 'AES-GCM', length: 256 },
                    false,
                    ['decrypt']
                );
                const decrypted = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: new Uint8Array(encryptedData.iv) },
                    derivedKey,
                    new Uint8Array(encryptedData.encrypted)
                );
                return decoder.decode(decrypted);
            }
        }


        // Google OAuth2 Authentication
        class GoogleAuth {
            constructor(clientId) {
                this.clientId = clientId;
                this.accessToken = null;
                this.isAuthenticated = false;
            }

            async authenticate() {
                return new Promise((resolve, reject) => {
                    // Use the newer Google Identity Services
                    if (typeof google !== 'undefined' && google.accounts) {
                        const client = google.accounts.oauth2.initTokenClient({
                            client_id: this.clientId,
                            scope: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/documents.readonly',
                            redirect_uri: window.location.origin + window.location.pathname,
                            callback: (response) => {
                                if (response.error) {
                                    reject(new Error(response.error));
                                } else {
                                    this.accessToken = response.access_token;
                                    this.isAuthenticated = true;
                                    resolve(this.accessToken);
                                }
                            }
                        });
                        client.requestAccessToken();
                    } else {
                        // Fallback to older gapi method
                        gapi.load('auth2', () => {
                            gapi.auth2.init({
                                client_id: this.clientId
                            }).then(() => {
                                const authInstance = gapi.auth2.getAuthInstance();
                                authInstance.signIn({
                                    scope: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/documents.readonly'
                                }).then((googleUser) => {
                                    this.accessToken = googleUser.getAuthResponse().access_token;
                                    this.isAuthenticated = true;
                                    resolve(this.accessToken);
                                }).catch(reject);
                            }).catch(reject);
                        });
                    }
                });
            }

            async makeAuthenticatedRequest(url, options = {}) {
                if (!this.isAuthenticated) {
                    await this.authenticate();
                }

                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Authorization': `Bearer ${this.accessToken}`,
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Google Sheets API Error:', {
                        status: response.status,
                        statusText: response.statusText,
                        url: url,
                        errorText: errorText
                    });
                    throw new Error(`Google Sheets API error: ${response.status} ${response.statusText}. Details: ${errorText}`);
                }
                
                return response.json();
            }

            getTemplateContent() {
                // Return template from localStorage or default
                return loadTemplate();
            }
        }

        // Google Sheets Storage Adapter with OAuth2
        class GoogleSheetsAdapter {
            constructor(sheetId, clientId) {
                this.sheetId = sheetId;
                this.auth = new GoogleAuth(clientId);
                this.baseUrl = 'https://sheets.googleapis.com/v4/spreadsheets';
                this.range = 'A:R'; // A-R for all 18 columns including metadata
            }

            async getSheetData() {
                try {
                    const url = `${this.baseUrl}/${this.sheetId}/values/${this.range}`;
                    console.log('Fetching sheet data from:', url);
                    const data = await this.auth.makeAuthenticatedRequest(url);
                    console.log('Sheet data received:', data);
                    return data.values || [];
                } catch (error) {
                    console.error('Error fetching sheet data:', error);
                    throw new Error(`Failed to fetch sheet data: ${error.message}`);
                }
            }

            async updateSheetData(values) {
                const url = `${this.baseUrl}/${this.sheetId}/values/${this.range}?valueInputOption=RAW`;
                const body = {
                    values: values
                };
                
                return this.auth.makeAuthenticatedRequest(url, {
                    method: 'PUT',
                    body: JSON.stringify(body)
                });
            }

            async getAllMentees() {
                try {
                    const rows = await this.getSheetData();
                    
                    // Skip header row if it exists
                    const dataRows = rows.length > 1 ? rows.slice(1) : rows;
                    
                    return dataRows.map((row, index) => {
                        // Debug: log the first few rows to see the actual data structure
                        if (index < 3) {
                            console.log(`Row ${index}:`, row);
                        }
                        
                        return {
                            id: row[0] || this.generateId(), // A: ID (generate if blank)
                            name: row[1] || '',              // B: NAME
                            mobile: row[2] || '',            // C: MOBILE
                            email: row[3] || '',             // D: EMAIL
                            fu: row[4] || '14',              // E: FU (follow-up days)
                            qs: row[5] || '',                // F: QS (Quad Squad)
                            poc: row[6] || '',               // G: POC (Point of Contact)
                            mf: row[7] || '',                // H: MF (Male/Female)
                            lot: row[8] || '',               // I: LOT (Leg of Training)
                            typ: row[9] || '',               // J: TYP (Type of School)
                            loc: row[10] || '',              // K: LOC (Location)
                            yr: row[11] || '',               // L: YR (Year)
                            notes: row[12] || '',            // M: NOTES
                            address: row[13] || '',          // N: ADDRESS
                            lastContact: row[14] || null,
                            interactions: row[15] ? JSON.parse(row[15]) : [],
                            createdAt: row[16] || new Date().toISOString(),
                            updatedAt: row[17] || new Date().toISOString()
                        };
                    });
                } catch (error) {
                    console.error('Error loading mentees from Google Sheets:', error);
                    return [];
                }
            }

            async saveMentees(mentees) {
                try {
                    // Create header row
                    const headerRow = ['id', 'name', 'mobile', 'email', 'fu', 'qs', 'poc', 'mf', 'lot', 'typ', 'loc', 'yr', 'notes', 'address', 'lastContact', 'interactions', 'createdAt', 'updatedAt'];
                    
                    // Convert mentees to rows
                    const dataRows = mentees.map(mentee => [
                        mentee.id || this.generateId(), // A: ID
                        mentee.name || '',              // B: NAME
                        mentee.mobile || '',            // C: MOBILE
                        mentee.email || '',             // D: EMAIL
                        mentee.fu || '14',              // E: FU (follow-up days)
                        mentee.qs || '',                // F: QS (Quad Squad)
                        mentee.poc || '',               // G: POC (Point of Contact)
                        mentee.mf || '',                // H: MF (Male/Female)
                        mentee.lot || '',               // I: LOT (Leg of Training)
                        mentee.typ || '',               // J: TYP (Type of School)
                        mentee.loc || '',               // K: LOC (Location)
                        mentee.yr || '',                // L: YR (Year)
                        mentee.notes || '',             // M: NOTES
                        mentee.address || '',           // N: ADDRESS
                        mentee.lastContact || '',
                        JSON.stringify(mentee.interactions || []),
                        mentee.createdAt || new Date().toISOString(),
                        mentee.updatedAt || new Date().toISOString()
                    ]);
                    
                    // Combine header and data
                    const allRows = [headerRow, ...dataRows];
                    
                    await this.updateSheetData(allRows);
                } catch (error) {
                    console.error('Error saving mentees to Google Sheets:', error);
                    throw error;
                }
            }

            async addMentee(mentee) {
                const mentees = await this.getAllMentees();
                mentee.id = this.generateId();
                mentee.createdAt = new Date().toISOString();
                mentee.updatedAt = new Date().toISOString();
                mentees.push(mentee);
                await this.saveMentees(mentees);
                return mentee;
            }

            async updateMentee(id, updates) {
                const mentees = await this.getAllMentees();
                const index = mentees.findIndex(m => m.id === id);
                if (index !== -1) {
                    mentees[index] = { ...mentees[index], ...updates, updatedAt: new Date().toISOString() };
                    await this.saveMentees(mentees);
                    return mentees[index];
                }
                return null;
            }

            async deleteMentee(id) {
                const mentees = await this.getAllMentees();
                const filtered = mentees.filter(m => m.id !== id);
                await this.saveMentees(filtered);
            }

            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }
        }

        // Main Application
        class MenteeTrackerApp {
            constructor() {
                // Check if configuration is set
                if (GOOGLE_SHEET_ID === 'YOUR_GOOGLE_SHEET_ID' || GOOGLE_CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID') {
                    console.error('Please configure GOOGLE_SHEET_ID and GOOGLE_CLIENT_ID at the top of this file');
                    alert('Please configure Google OAuth2 settings before using the app. Check the console for instructions.');
                }
                
                this.storage = new GoogleSheetsAdapter(GOOGLE_SHEET_ID, GOOGLE_CLIENT_ID);
                this.mentees = [];
                this.currentEditingMenteeId = null;
                this.searchTerm = '';
            }

            // Check if mentee needs follow-up (red alert)
            needsFollowUp(mentee) {
                if (!mentee.fu || !mentee.lastContact) {
                    return true; // Red if no follow-up days set or no last contact
                }
                
                const lastContactDate = new Date(mentee.lastContact);
                const daysSinceContact = Math.floor((new Date() - lastContactDate) / (1000 * 60 * 60 * 24));
                const maxDays = parseInt(mentee.fu) || 30;
                
                return daysSinceContact > maxDays;
            }


            async init() {
                try {
                    this.updateConnectionStatus('loading', 'Loading Google APIs...');
                    
                    // Wait for Google APIs to load
                    await this.waitForGoogleAPIs();
                    
                    this.updateConnectionStatus('loading', 'Authenticating with Google...');
                    
                    // Authenticate with Google
                    await this.storage.auth.authenticate();
                    
                    this.updateConnectionStatus('loading', 'Testing sheet access...');
                    
                    // Test sheet access first with a simple range
                    try {
                        console.log('Testing sheet access with range A1:A1...');
                        const testUrl = `https://sheets.googleapis.com/v4/spreadsheets/${this.storage.sheetId}/values/A1:A1`;
                        const testData = await this.storage.auth.makeAuthenticatedRequest(testUrl);
                        console.log('Basic sheet access test successful:', testData);
                        
                        // Now try the full range
                        await this.storage.getSheetData();
                        console.log('Full sheet access test successful');
                    } catch (error) {
                        console.error('Sheet access test failed:', error);
                        this.updateConnectionStatus('error', `Cannot access sheet: ${error.message}`);
                        return;
                    }
                    
                    this.updateConnectionStatus('loading', 'Loading data from Google Sheets...');
                    
                    await this.loadMentees();
                    
                    this.updateConnectionStatus('connected', '‚úÖ Connected to Google Sheets');
                this.setupEventListeners();
                this.render();
                } catch (error) {
                    console.error('Error initializing app:', error);
                    this.updateConnectionStatus('error', `‚ùå Error: ${error.message}`);
                    this.showToast(`Error: ${error.message}`, 'error');
                }
            }

            async waitForGoogleAPIs() {
                return new Promise((resolve, reject) => {
                    let attempts = 0;
                    const maxAttempts = 50; // 5 seconds max
                    
                    const checkAPIs = () => {
                        attempts++;
                        
                        if (typeof google !== 'undefined' && (google.accounts || gapi)) {
                            resolve();
                        } else if (attempts >= maxAttempts) {
                            reject(new Error('Google APIs failed to load. Please refresh the page.'));
                        } else {
                            setTimeout(checkAPIs, 100);
                        }
                    };
                    
                    checkAPIs();
                });
            }

            updateConnectionStatus(type, message) {
                // Connection status display was removed, so just log the status
                console.log(`Connection status: ${type} - ${message}`);
            }

            setupEventListeners() {
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    console.log('Search input found, adding event listener');
                    searchInput.addEventListener('input', (e) => {
                        console.log('Search input changed:', e.target.value);
                        this.searchTerm = e.target.value.toLowerCase();
                        this.render();
                    });
                } else {
                    console.error('Search input not found');
                }

                // Close modal on background click
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            this.closeModal(modal.id);
                        }
                    });
                });

                // Close dropdown menu when clicking outside
                document.addEventListener('click', (e) => {
                    const menu = document.getElementById('dropdownMenu');
                    const menuButton = document.querySelector('.menu-button');
                    if (menu && menuButton && !menuButton.contains(e.target) && !menu.contains(e.target)) {
                        menu.classList.remove('show');
                    }
                });
            }

            async loadMentees() {
                try {
                this.mentees = await this.storage.getAllMentees();
                    console.log('Loaded mentees:', this.mentees.length);
                    console.log('First mentee:', this.mentees[0]);
                } catch (error) {
                    console.error('Error loading mentees:', error);
                    this.mentees = [];
                }
            }


            getFilteredMentees() {
                let filtered = this.mentees;

                if (this.searchTerm) {
                    console.log('Searching for:', this.searchTerm);
                    filtered = filtered.filter(m => 
                        (m.name || '').toLowerCase().includes(this.searchTerm) ||
                        (m.mobile || '').toLowerCase().includes(this.searchTerm) ||
                        (m.email || '').toLowerCase().includes(this.searchTerm) ||
                        (m.qs || '').toLowerCase().includes(this.searchTerm) ||
                        (m.lot || '').toLowerCase().includes(this.searchTerm) ||
                        (m.loc || '').toLowerCase().includes(this.searchTerm) ||
                        (m.typ || '').toLowerCase().includes(this.searchTerm) ||
                        (m.yr || '').toLowerCase().includes(this.searchTerm) ||
                        (m.notes || '').toLowerCase().includes(this.searchTerm)
                    );
                    console.log('Filtered results:', filtered.length);
                }

                // Always sort alphabetically by name
                filtered.sort((a, b) => (a.name || '').localeCompare(b.name || ''));

                return filtered;
            }

            getDaysAgo(date, fuDays = 14) {
                if (!date) return { color: 'red', label: 'Never contacted', days: 999 };
                
                const now = new Date();
                const lastContact = new Date(date);
                const diffTime = Math.abs(now - lastContact);
                const days = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                if (days >= fuDays) return { color: 'red', label: `${days} days ago`, days };
                if (days >= Math.floor(fuDays / 2)) return { color: 'yellow', label: `${days} days ago`, days };
                if (days === 0) return { color: 'green', label: 'Today', days };
                if (days === 1) return { color: 'green', label: 'Yesterday', days };
                return { color: 'green', label: `${days} days ago`, days };
            }

            getWeeklyStats() {
                const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                let weeklyCount = 0;

                this.mentees.forEach(mentee => {
                    if (mentee.interactions) {
                        mentee.interactions.forEach(interaction => {
                            if (new Date(interaction.timestamp) >= weekAgo) {
                                weeklyCount++;
                            }
                        });
                    }
                });

                return weeklyCount;
            }

            async logInteraction(menteeId, type, notes = '') {
                const mentee = this.mentees.find(m => m.id === menteeId);
                if (!mentee) return;

                const interaction = {
                    type,
                    timestamp: new Date().toISOString(),
                    notes: notes || ''
                };

                const interactions = mentee.interactions || [];
                interactions.unshift(interaction);

                await this.storage.updateMentee(menteeId, {
                    lastContact: interaction.timestamp,
                    interactions
                });

                await this.loadMentees();
                
                // If we're in contact view, refresh it; otherwise render list
                const container = document.getElementById('menteeList');
                if (container && container.querySelector('.contact-view')) {
                    this.showContactView(menteeId);
                } else {
                    this.render();
                }
                
                // Show success notice
                const toastNames = {
                    'text': 'üì± Text',
                    'call': 'üìû Call',
                    'email': 'üìß Email',
                    'ftf': 'ü§ù Face-to-Face'
                };
                const toastMessage = notes ? `${toastNames[type] || type} (${notes}) logged` : `${toastNames[type] || type} logged`;
                this.showToast(toastMessage, 'success');
            }

            async logFaceToFace(menteeId) {
                const mentee = this.mentees.find(m => m.id === menteeId);
                if (!mentee) return;

                // Prompt for FTF type with default
                const ftfType = prompt(
                    `Face-to-Face meeting with ${mentee.name}\n\n` +
                    `Enter type (SC/SO/QS/OP/CO/ME or custom):`,
                    'SC'
                );

                // Use default if cancelled or empty
                const finalType = (ftfType === null || ftfType.trim() === '') ? 'FTF' : ftfType.trim();
                await this.logInteraction(menteeId, 'ftf', finalType);
            }

            async initiateContact(menteeId, type) {
                const mentee = this.mentees.find(m => m.id === menteeId);
                if (!mentee) return;

                // Always try to use template first, fallback to regular contact
                try {
                    const templateContent = this.storage.auth.getTemplateContent();
                    if (templateContent && templateContent.trim()) {
                        if (type === 'email') {
                            if (!mentee.email) return;
                            // Parse template for subject and body
                            const lines = templateContent.split('\n');
                            let subject = '';
                            let body = '';
                            let inBody = false;
                            
                            for (let i = 0; i < lines.length; i++) {
                                const line = lines[i];
                                if (line.toLowerCase().startsWith('subject:')) {
                                    // Subject is on the same line after the colon
                                    subject = line.substring(8).trim();
                                } else if (line.toLowerCase().startsWith('body:')) {
                                    inBody = true;
                                    // Body starts on the next line
                                    if (i + 1 < lines.length) {
                                        body = lines[i + 1].trim();
                                    }
                                } else if (inBody && line.trim() !== '') {
                                    body += '\n' + line;
                                }
                            }
                            
                            // Replace [FirstName] with actual mentee name
                            const firstName = mentee.name.split(' ')[0];
                            body = body.replace(/\[FirstName\]/g, firstName);
                            
                            const gmailUrl = `https://mail.google.com/mail/?view=cm&to=${encodeURIComponent(mentee.email)}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                            window.open(gmailUrl, '_blank');
                        } else if (type === 'text') {
                            if (!mentee.mobile) return;
                            const cleanPhone = mentee.mobile.replace(/\D/g, '');
                            // For text, use just the body content without subject
                            const lines = templateContent.split('\n');
                            let body = '';
                            let inBody = false;
                            
                            for (let i = 0; i < lines.length; i++) {
                                const line = lines[i];
                                if (line.toLowerCase().startsWith('body:')) {
                                    inBody = true;
                                    // Body starts on the next line
                                    if (i + 1 < lines.length) {
                                        body = lines[i + 1].trim();
                                    }
                                } else if (inBody && line.trim() !== '') {
                                    body += '\n' + line;
                                }
                            }
                            
                            // Replace [FirstName] with actual mentee name
                            const firstName = mentee.name.split(' ')[0];
                            body = body.replace(/\[FirstName\]/g, firstName);
                            
                            const smsUrl = `sms:${cleanPhone}&body=${encodeURIComponent(body)}`;
                            window.location.href = smsUrl;
                        }
                    } else {
                        // No template available, use regular contact
                        this.initiateContactWithoutTemplate(menteeId, type);
                    }
                } catch (error) {
                    console.error('Error using template:', error);
                    // Fallback to regular contact
                    this.initiateContactWithoutTemplate(menteeId, type);
                }
            }

            initiateContactWithoutTemplate(menteeId, type) {
                const mentee = this.mentees.find(m => m.id === menteeId);
                if (!mentee) return;

                if (type === 'email') {
                    if (!mentee.email) return;
                    window.open(`https://mail.google.com/mail/?view=cm&to=${encodeURIComponent(mentee.email)}`, '_blank');
                } else if (type === 'text') {
                    if (!mentee.mobile) return;
                    const cleanPhone = mentee.mobile.replace(/\D/g, '');
                    window.location.href = `sms:${cleanPhone}`;
                } else if (type === 'call') {
                    if (!mentee.mobile) return;
                    const cleanPhone = mentee.mobile.replace(/\D/g, '');
                    window.location.href = `tel:${cleanPhone}`;
                }
            }

            showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast ${type} show`;
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            showEditNotesModal(menteeId) {
                const mentee = this.mentees.find(m => m.id === menteeId);
                if (!mentee) return;

                this.currentEditingMenteeId = menteeId;
                document.getElementById('notesModalName').textContent = mentee.name;
                document.getElementById('notesText').value = mentee.notes || '';
                document.getElementById('notesModal').classList.add('active');
            }

            async saveNotes() {
                if (!this.currentEditingMenteeId) return;

                const notes = document.getElementById('notesText').value;
                await this.storage.updateMentee(this.currentEditingMenteeId, { notes });
                
                await this.loadMentees();
                this.closeModal('notesModal');
                this.render();
            }

            toggleMenu() {
                console.log('Toggle menu clicked');
                const menu = document.getElementById('dropdownMenu');
                if (menu) {
                    console.log('Menu found, toggling show class');
                    menu.classList.toggle('show');
                    console.log('Menu classes:', menu.className);
                } else {
                    console.error('Dropdown menu not found');
                }
            }

            showStats() {
                const needsContact = this.mentees.filter(m => {
                    const info = this.getDaysAgo(m.lastContact, parseInt(m.fu) || 14);
                    return info.days >= Math.floor((parseInt(m.fu) || 14) / 2);
                }).length;

                const weeklyContacts = this.getWeeklyStats();
                
                alert(`üìä Statistics\n\n` +
                      `Total Mentees: ${this.mentees.length}\n` +
                      `Need Contact: ${needsContact}\n` +
                      `This Week: ${weeklyContacts}`);
                
                // Close the dropdown
                const menu = document.getElementById('dropdownMenu');
                if (menu) {
                    menu.classList.remove('show');
                }
            }

            showTemplateEditor() {
                const template = loadTemplate();
                let subject = '';
                let body = '';
                
                if (template) {
                    const lines = template.split('\n');
                    let inBody = false;
                    
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i];
                        if (line.toLowerCase().startsWith('subject:')) {
                            subject = line.substring(8).trim();
                        } else if (line.toLowerCase().startsWith('body:')) {
                            inBody = true;
                            if (i + 1 < lines.length) {
                                body = lines[i + 1].trim();
                            }
                        } else if (inBody && line.trim() !== '') {
                            body += '\n' + line;
                        }
                    }
                }
                
                document.getElementById('templateSubject').value = subject;
                document.getElementById('templateBody').value = body;
                document.getElementById('templateEditorModal').classList.add('active');
                
                // Close the dropdown
                const menu = document.getElementById('dropdownMenu');
                if (menu) {
                    menu.classList.remove('show');
                }
            }

            saveTemplate() {
                const subject = document.getElementById('templateSubject').value.trim();
                const body = document.getElementById('templateBody').value.trim();
                
                let template = '';
                if (subject || body) {
                    if (subject) {
                        template = `Subject: ${subject}\n\n`;
                    }
                    template += 'Body:\n';
                    if (body) {
                        template += body;
                    }
                }
                
                saveTemplateToStorage(template);
                this.closeModal('templateEditorModal');
                this.showToast('Template saved successfully!', 'success');
            }

            clearTemplate() {
                if (confirm('Are you sure you want to clear the template? This will disable automatic text insertion.')) {
                    document.getElementById('templateSubject').value = '';
                    document.getElementById('templateBody').value = '';
                    saveTemplateToStorage('');
                    this.showToast('Template cleared', 'success');
                }
            }

            navigateToNext(menteeId) {
                const filteredMentees = this.getFilteredMentees();
                const currentIndex = filteredMentees.findIndex(m => m.id === menteeId);
                if (currentIndex >= 0 && currentIndex < filteredMentees.length - 1) {
                    this.showContactView(filteredMentees[currentIndex + 1].id);
                }
            }

            navigateToPrevious(menteeId) {
                const filteredMentees = this.getFilteredMentees();
                const currentIndex = filteredMentees.findIndex(m => m.id === menteeId);
                if (currentIndex > 0) {
                    this.showContactView(filteredMentees[currentIndex - 1].id);
                }
            }

            showContactView(menteeId) {
                const mentee = this.mentees.find(m => m.id === menteeId);
                if (!mentee) return;

                const container = document.getElementById('menteeList');
                if (!container) return;

                // Get filtered list for navigation
                const filteredMentees = this.getFilteredMentees();
                const currentIndex = filteredMentees.findIndex(m => m.id === menteeId);
                const hasNext = currentIndex >= 0 && currentIndex < filteredMentees.length - 1;
                const hasPrevious = currentIndex > 0;

                // Build disabled attributes
                const prevDisabled = hasPrevious ? '' : ' disabled';
                const nextDisabled = hasNext ? '' : ' disabled';

                // Calculate time since last contact
                const lastContactInfo = this.getDaysAgo(mentee.lastContact, parseInt(mentee.fu) || 14);
                const needsFollowUp = this.needsFollowUp(mentee);
                const statusColor = needsFollowUp ? 'red' : lastContactInfo.color;
                const statusText = needsFollowUp ? 'üî¥ NEEDS FOLLOW-UP' : lastContactInfo.text;

                // Get recent interactions
                const recentInteractions = (mentee.interactions || []).slice(0, 10);

                container.innerHTML = `
                    <div class="contact-view">
                        <div class="contact-header">
                            <div class="header-left-nav">
                                <button class="btn-back" onclick="app.render()">‚Üê Back</button>
                                <button class="btn-nav" onclick="app.navigateToPrevious('${menteeId}')"${prevDisabled}>‚Üê Prev</button>
                            </div>
                            <div class="contact-title">
                                <h2>${this.escapeHtml(mentee.name)}</h2>
                                <div class="contact-status status-${statusColor}">${statusText}</div>
                            </div>
                            <div class="header-right-nav">
                                <button class="btn-nav" onclick="app.navigateToNext('${menteeId}')"${nextDisabled}>Next ‚Üí</button>
                                <button class="btn-edit" onclick="app.showEditMenteeModal('${mentee.id}')">‚úèÔ∏è Edit</button>
                            </div>
                        </div>
                        
                        <div class="contact-photo-section">
                            <div class="contact-photo">
                                ${mentee.photo ? 
                                    `<img src="${mentee.photo}" alt="${mentee.name}" class="profile-photo">` : 
                                    `<div class="photo-placeholder">üì∑</div>`
                                }
                                <button class="btn-photo" onclick="app.uploadPhoto('${mentee.id}')" title="Add Photo">
                                    ${mentee.photo ? 'üì∑' : 'üì∑ Add Photo'}
                                </button>
                            </div>
                        </div>
                        
                        <div class="contact-info">
                            ${mentee.mobile ? `
                                <div class="contact-item">
                                    <div class="contact-label">üì± Mobile</div>
                                    <div class="contact-value">
                                        <a href="tel:${mentee.mobile}">${mentee.mobile}</a>
                                        <button class="btn-text-small" onclick="app.initiateContactWithoutTemplate('${mentee.id}', 'text')">üì± Text</button>
                                        <button class="btn-insert-text" onclick="app.initiateContact('${mentee.id}', 'text')">üìù Insert Text</button>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${mentee.email ? `
                                <div class="contact-item">
                                    <div class="contact-label">üìß Email</div>
                                    <div class="contact-value">
                                        <a href="mailto:${mentee.email}" onclick="app.handleEmailClick('${mentee.id}', event)">${mentee.email}</a>
                                        <button class="btn-insert-text" onclick="app.initiateContact('${mentee.id}', 'email')">üìù Insert Text</button>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="contact-item">
                                <div class="contact-label">üìã Log Interaction</div>
                                <div class="contact-value">
                                    <div class="log-buttons">
                                        <button class="btn-log txt" onclick="app.logInteraction('${mentee.id}', 'text')">üì± TXT</button>
                                        <button class="btn-log call" onclick="app.logInteraction('${mentee.id}', 'call')">üìû PC</button>
                                        <button class="btn-log email" onclick="app.logInteraction('${mentee.id}', 'email')">üìß EM</button>
                                        <button class="btn-log ftf" onclick="app.logFaceToFace('${mentee.id}')">ü§ù FTF</button>
                                    </div>
                                </div>
                            </div>
                            
                            ${mentee.loc ? `
                                <div class="contact-item">
                                    <div class="contact-label">üè´ School</div>
                                    <div class="contact-value">${this.escapeHtml(mentee.loc)}</div>
                                </div>
                            ` : ''}
                            
                            ${mentee.yr ? `
                                <div class="contact-item">
                                    <div class="contact-label">üéì Grad Yr</div>
                                    <div class="contact-value">${this.escapeHtml(mentee.yr)}</div>
                                </div>
                            ` : ''}
                            
                            ${mentee.lot ? `
                                <div class="contact-item">
                                    <div class="contact-label">üìö Level</div>
                                    <div class="contact-value">${this.escapeHtml(mentee.lot)}</div>
                                </div>
                            ` : ''}
                            
                            ${mentee.typ ? `
                                <div class="contact-item">
                                    <div class="contact-label">üè• Type</div>
                                    <div class="contact-value">${this.escapeHtml(mentee.typ)}</div>
                                </div>
                            ` : ''}
                            
                            ${mentee.qs ? `
                                <div class="contact-item">
                                    <div class="contact-label">üë• Quad Squad</div>
                                    <div class="contact-value">${this.escapeHtml(mentee.qs)}</div>
                                </div>
                            ` : ''}
                            
                            ${mentee.poc ? `
                                <div class="contact-item">
                                    <div class="contact-label">‚≠ê Point of Contact</div>
                                    <div class="contact-value">${this.escapeHtml(mentee.poc)}</div>
                                </div>
                            ` : ''}
                            
                            ${mentee.mf ? `
                                <div class="contact-item">
                                    <div class="contact-label">üë§ Gender</div>
                                    <div class="contact-value">${this.escapeHtml(mentee.mf)}</div>
                                </div>
                            ` : ''}
                            
                            ${mentee.address ? `
                                <div class="contact-item">
                                    <div class="contact-label">üìç Address</div>
                                    <div class="contact-value">${this.escapeHtml(mentee.address)}</div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="contact-log-section">
                            <h3>üìã Interaction History</h3>
                            <div class="interaction-history">
                                ${recentInteractions.length > 0 ? 
                                    recentInteractions.map(interaction => {
                                        const icon = interaction.type === 'text' ? 'üì±' : 
                                                    interaction.type === 'call' ? 'üìû' : 
                                                    interaction.type === 'ftf' ? 'ü§ù' : 'üìß';
                                        const noteText = interaction.notes ? ` - ${interaction.notes}` : '';
                                        return `
                                        <div class="log-entry">
                                            <span class="log-icon">${icon}</span>
                                            <span class="log-date">${this.formatDate(interaction.timestamp)}</span>
                                            <span class="log-notes">${this.escapeHtml(interaction.notes || '')}</span>
                                        </div>
                                    `;
                                    }).join('') : 
                                    '<div class="no-interactions">No interactions logged yet</div>'
                                }
                            </div>
                        </div>
                        
                        ${mentee.notes ? `
                            <div class="contact-notes">
                                <h3>üìù Notes</h3>
                                <div class="notes-content">${this.escapeHtml(mentee.notes)}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            handleEmailClick(menteeId, event) {
                event.preventDefault();
                // Open blank email (no template)
                this.initiateContactWithoutTemplate(menteeId, 'email');
            }

            uploadPhoto(menteeId) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        // Check file size (max 5MB)
                        if (file.size > 5 * 1024 * 1024) {
                            this.showToast('Photo too large. Please choose a file under 5MB.', 'error');
                            return;
                        }
                        
                        const reader = new FileReader();
                        reader.onload = async (e) => {
                            const photoData = e.target.result;
                            try {
                                await this.storage.updateMentee(menteeId, { photo: photoData });
                                this.showToast('Photo uploaded successfully!', 'success');
                                this.showContactView(menteeId); // Refresh the view
                            } catch (error) {
                                console.error('Error uploading photo:', error);
                                this.showToast('Error uploading photo', 'error');
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                };
                input.click();
            }

            showEditMenteeModal(menteeId) {
                const mentee = this.mentees.find(m => m.id === menteeId);
                if (!mentee) return;

                // Pre-fill the form with existing data
                document.getElementById('menteeName').value = mentee.name || '';
                document.getElementById('menteeMobile').value = mentee.mobile || '';
                document.getElementById('menteeEmail').value = mentee.email || '';
                document.getElementById('menteeFu').value = mentee.fu || '';
                document.getElementById('menteeQs').value = mentee.qs || '';
                document.getElementById('menteePoc').value = mentee.poc || '';
                document.getElementById('menteeMf').value = mentee.mf || '';
                document.getElementById('menteeLot').value = mentee.lot || '';
                document.getElementById('menteeTyp').value = mentee.typ || '';
                document.getElementById('menteeLoc').value = mentee.loc || '';
                document.getElementById('menteeYr').value = mentee.yr || '';
                document.getElementById('menteeNotes').value = mentee.notes || '';
                document.getElementById('menteeAddress').value = mentee.address || '';

                // Store the mentee ID for editing
                document.getElementById('addMenteeModal').setAttribute('data-edit-id', menteeId);
                
                // Change the modal title and button
                document.querySelector('#addMenteeModal h2').textContent = 'Edit Contact';
                document.querySelector('#addMenteeModal button[type="submit"]').textContent = 'Update Contact';
                
                document.getElementById('addMenteeModal').classList.add('show');
            }

            showAddMenteeModal() {
                try {
                document.getElementById('menteeName').value = '';
                    document.getElementById('menteeMobile').value = '';
                    document.getElementById('menteeEmail').value = '';
                    document.getElementById('menteeFu').value = '14';
                    document.getElementById('menteeQs').value = '';
                    document.getElementById('menteePoc').value = '';
                    document.getElementById('menteeMf').value = '';
                    document.getElementById('menteeLot').value = '';
                    document.getElementById('menteeTyp').value = '';
                    document.getElementById('menteeLoc').value = '';
                    document.getElementById('menteeYr').value = '';
                    document.getElementById('menteeNotes').value = '';
                    document.getElementById('menteeAddress').value = '';
                } catch (error) {
                    console.error('Error clearing form fields:', error);
                }
                document.getElementById('addMenteeModal').classList.add('active');
            }

            async addMentee() {
                console.log('addMentee called');
                try {
                    const name = document.getElementById('menteeName').value.trim();
                    const mobile = document.getElementById('menteeMobile').value.trim();
                    const email = document.getElementById('menteeEmail').value.trim();
                    const fu = document.getElementById('menteeFu').value.trim();
                    const qs = document.getElementById('menteeQs').value.trim();
                    const poc = document.getElementById('menteePoc').value;
                    const mf = document.getElementById('menteeMf').value;
                    const lot = document.getElementById('menteeLot').value;
                    const typ = document.getElementById('menteeTyp').value.trim();
                    const loc = document.getElementById('menteeLoc').value.trim();
                    const yr = document.getElementById('menteeYr').value.trim();
                    const notes = document.getElementById('menteeNotes').value.trim();
                    const address = document.getElementById('menteeAddress').value.trim();

                    if (!name) {
                        alert('Please enter a name');
                        return;
                    }

                    const modal = document.getElementById('addMenteeModal');
                    const editId = modal.getAttribute('data-edit-id');
                    
                    if (editId) {
                        // Editing existing mentee
                        const mentee = {
                            name,
                            mobile,
                            email,
                            fu: parseInt(fu) || 30,
                            qs: qs || '',
                            poc: poc || '',
                            mf: mf || '',
                            lot: lot || '',
                            typ: typ || '',
                            loc: loc || '',
                            yr: yr || '',
                            notes: notes || '',
                            address: address || ''
                        };

                        await this.storage.updateMentee(editId, mentee);
                        this.closeModal('addMenteeModal');
                        await this.loadMentees();
                        this.render();
                        this.showToast(`${name} updated successfully!`, 'success');
                        
                        // Reset modal for future use
                        modal.removeAttribute('data-edit-id');
                        document.querySelector('#addMenteeModal h2').textContent = 'Add New Contact';
                        document.querySelector('#addMenteeModal button[type="submit"]').textContent = 'Add Contact';
                    } else {
                        // Adding new mentee
                        const newMentee = {
                            name,
                            mobile,
                            email,
                            fu: parseInt(fu) || 30,
                            qs: qs || '',
                            poc: poc || '',
                            mf: mf || '',
                            lot: lot || '',
                            typ: typ || '',
                            loc: loc || '',
                            yr: yr || '',
                            notes: notes || '',
                            address: address || '',
                            lastContact: null,
                            interactions: []
                        };

                        await this.storage.addMentee(newMentee);
                        this.closeModal('addMenteeModal');
                        await this.loadMentees();
                        this.render();
                        this.showToast(`${name} added successfully!`, 'success');
                    }
                } catch (error) {
                    console.error('Error saving mentee:', error);
                    alert(`Error saving mentee: ${error.message}`);
                }
            }

            async deleteMentee(menteeId) {
                const mentee = this.mentees.find(m => m.id === menteeId);
                if (!mentee) return;

                if (confirm(`Are you sure you want to delete ${mentee.name}?`)) {
                    await this.storage.deleteMentee(menteeId);
                    await this.loadMentees();
                    this.render();
                }
            }

            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
                this.currentEditingMenteeId = null;
            }

            showBulkImportModal() {
                document.getElementById('bulkImportModal').classList.add('active');
                
                // Add event listeners for radio buttons
                document.querySelectorAll('input[name="importType"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        const newSheetConfig = document.getElementById('newSheetConfig');
                        if (e.target.value === 'fromNewSheet') {
                            newSheetConfig.style.display = 'block';
                        } else {
                            newSheetConfig.style.display = 'none';
                        }
                    });
                });
            }

            async startBulkImport() {
                const importType = document.querySelector('input[name="importType"]:checked').value;
                const skipDuplicates = document.getElementById('skipDuplicates').checked;
                const clearExisting = document.getElementById('clearExisting').checked;
                
                let sourceSheetId = GOOGLE_SHEET_ID;
                if (importType === 'fromNewSheet') {
                    sourceSheetId = document.getElementById('importSheetId').value.trim();
                    if (!sourceSheetId) {
                        alert('Please enter a Google Sheet ID');
                        return;
                    }
                }

                try {
                    this.updateConnectionStatus('loading', 'Importing data from Google Sheets...');
                    
                    // Create a temporary adapter for the source sheet
                    const sourceAdapter = new GoogleSheetsAdapter(sourceSheetId, GOOGLE_CLIENT_ID);
                    const sourceData = await sourceAdapter.getSheetData();
                    
                    if (sourceData.length === 0) {
                        alert('No data found in the source sheet');
                        return;
                    }

                    // Parse the source data
                    const importedMentees = this.parseImportedData(sourceData);
                    
                    if (importedMentees.length === 0) {
                        alert('No valid mentee data found to import');
                        return;
                    }

                    // Get current mentees
                    let currentMentees = await this.storage.getAllMentees();
                    
                    if (clearExisting) {
                        currentMentees = [];
                    }

                    // Merge data
                    let finalMentees = [...currentMentees];
                    let importedCount = 0;
                    let skippedCount = 0;

                    for (const importedMentee of importedMentees) {
                        if (skipDuplicates) {
                            const exists = finalMentees.some(m => 
                                m.name.toLowerCase() === importedMentee.name.toLowerCase()
                            );
                            if (exists) {
                                skippedCount++;
                                continue;
                            }
                        }
                        
                        // Add creation timestamp
                        importedMentee.createdAt = new Date().toISOString();
                        importedMentee.updatedAt = new Date().toISOString();
                        
                        finalMentees.push(importedMentee);
                        importedCount++;
                    }

                    // Save to Google Sheets
                    await this.storage.saveMentees(finalMentees);
                    await this.loadMentees();
                    this.render();
                    
                    this.closeModal('bulkImportModal');
                    this.updateConnectionStatus('connected', '‚úÖ Connected to Google Sheets');
                    
                    this.showToast(
                        `Import complete! ${importedCount} mentees imported, ${skippedCount} duplicates skipped.`, 
                        'success'
                    );
                    
                } catch (error) {
                    console.error('Bulk import error:', error);
                    this.updateConnectionStatus('error', '‚ùå Import failed. Check console for details.');
                    alert('Import failed: ' + error.message);
                }
            }

            parseImportedData(sourceData) {
                // Skip header row if it exists
                const dataRows = sourceData.length > 1 ? sourceData.slice(1) : sourceData;
                
                return dataRows.map((row, index) => {
                    // Map columns based on your actual spreadsheet structure:
                    // A=ID, B=NAME, C=MOBILE, D=EMAIL, E=FU, F=QS, G=POC, H=MF, I=LOT, J=TYP, K=LOC, L=YR, M=NOTES, N=ADDRESS
                    const mentee = {
                        id: row[0] || this.generateId(),                          // A: ID (generate if blank)
                        name: row[1] || `Imported Mentee ${index + 1}`,           // B: NAME
                        mobile: row[2] || '',                                      // C: MOBILE
                        email: row[3] || '',                                       // D: EMAIL
                        fu: row[4] || '14',                                        // E: FU (default 14 days)
                        qs: row[5] || '',                                          // F: QS
                        poc: row[6] || '',                                         // G: POC
                        mf: row[7] || '',                                          // H: MF
                        lot: row[8] || '',                                         // I: LOT
                        typ: row[9] || '',                                         // J: TYP
                        loc: row[10] || '',                                        // K: LOC
                        yr: row[11] || '',                                         // L: YR
                        notes: row[12] || '',                                      // M: NOTES
                        address: row[13] || '',                                    // N: ADDRESS
                        lastContact: null,
                        interactions: []
                    };
                    
                    return mentee;
                }).filter(mentee => mentee.name && mentee.name !== 'Imported Mentee');
            }


            exportData() {
                const dataStr = JSON.stringify(this.mentees, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `mentee-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
            }

            async importData(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedMentees = JSON.parse(e.target.result);
                        
                        if (!Array.isArray(importedMentees)) {
                            alert('Invalid file format');
                            return;
                        }

                        if (confirm(`This will replace your current data with ${importedMentees.length} mentees. Continue?`)) {
                            await this.storage.saveMentees(importedMentees);
                            await this.loadMentees();
                            this.render();
                            alert('Data imported successfully!');
                        }
                    } catch (error) {
                        alert('Error importing data: ' + error.message);
                    }
                };
                reader.readAsText(file);
                event.target.value = ''; // Reset input
            }

            render() {
                this.renderMenteeList();
            }

            renderStats() {
                console.log('Rendering stats for', this.mentees.length, 'mentees');
                const needsContact = this.mentees.filter(m => {
                    const info = this.getDaysAgo(m.lastContact, parseInt(m.fu) || 14);
                    return info.days >= Math.floor((parseInt(m.fu) || 14) / 2);
                }).length;

                const totalElement = document.getElementById('totalMentees');
                const needsElement = document.getElementById('needsContact');
                const weeklyElement = document.getElementById('weeklyContacts');

                if (totalElement) totalElement.textContent = this.mentees.length;
                if (needsElement) needsElement.textContent = needsContact;
                if (weeklyElement) weeklyElement.textContent = this.getWeeklyStats();

                console.log('Stats updated:', {
                    total: this.mentees.length,
                    needsContact: needsContact,
                    weekly: this.getWeeklyStats()
                });
            }


            renderMenteeList() {
                const container = document.getElementById('menteeList');
                if (!container) {
                    console.error('Mentee list container not found');
                    return;
                }
                
                const filteredMentees = this.getFilteredMentees();
                console.log('Rendering', filteredMentees.length, 'mentees');

                if (filteredMentees.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p>No mentees found</p>
                            <button class="btn-primary" onclick="app.showAddMenteeModal()">Add Your First Mentee</button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = filteredMentees.map(mentee => {
                    return `
                        <div class="mentee-list-item" onclick="app.showContactView('${mentee.id}')">
                            <div class="mentee-info">
                                <div class="mentee-name">${this.escapeHtml(mentee.name)}</div>
                                <div class="mentee-details">
                                    ${mentee.loc ? `<span class="school">${this.escapeHtml(mentee.loc)}</span>` : ''}
                                    ${mentee.yr ? `<span class="year">${this.escapeHtml(mentee.yr)}</span>` : ''}
                                </div>
                            </div>
                            <div class="mentee-arrow">‚Üí</div>
                        </div>
                    `;
                }).join('');
            }

            formatDate(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

                if (diffDays === 0) {
                    return 'Today at ' + date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                } else if (diffDays === 1) {
                    return 'Yesterday at ' + date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                } else if (diffDays < 7) {
                    return date.toLocaleDateString('en-US', { weekday: 'short', hour: 'numeric', minute: '2-digit' });
                } else {
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Initialize app
        const app = new MenteeTrackerApp();
        app.init();
    </script>
</body>
</html>

